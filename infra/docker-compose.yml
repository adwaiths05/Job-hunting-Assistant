services:
  # üß† Vector Database
  weaviate:
    image: semitechnologies/weaviate:latest
    container_name: weaviate
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - QUERY_DEFAULTS_LIMIT=20
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      - ENABLE_MODULES=text2vec-transformers
    volumes:
      - weaviate_data:/var/lib/weaviate

  # ‚ö° Cache & Task Queue
  redis:
    image: redis:alpine
    container_name: job-redis
    ports:
      - "6379:6379"

  # üêç Python Backend
  backend:
    build:
      context: ..
      dockerfile: infra/Dockerfile.backend
    container_name: job-backend
    ports:
      - "8000:8000"
    environment:
      - WEAVIATE_URL=http://weaviate:8080
      - REDIS_URL=redis://redis:6379
      # MCP Server URLs (Internal Docker Network)
      - BROWSER_MCP_URL=http://browser-mcp:3001/sse
      - NOTION_MCP_URL=http://notion-mcp:3002/sse
      - GMAIL_MCP_URL=http://gmail-mcp:3003/sse
      - CALENDAR_MCP_URL=http://calendar-mcp:3004/sse
      # API Keys
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - NOTION_TOKEN=${NOTION_TOKEN}
      - NOTION_DB_ID=${NOTION_DB_ID}
    depends_on:
      - weaviate
      - redis
      - browser-mcp
      - notion-mcp

  # üåê Browser MCP Agent (Updated to use Playwright image)
  browser-mcp:
    build:
      context: ../mcp-servers/browser-mcp
      dockerfile: ../../infra/Dockerfile.browser
    container_name: mcp-browser
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
    # Shared memory size is crucial for Playwright stability
    shm_size: '2gb'

  # üìù Notion MCP Agent
  notion-mcp:
    build:
      context: ../mcp-servers/notion-mcp
      dockerfile: ../../infra/Dockerfile.mcp
    container_name: mcp-notion
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - NOTION_API_KEY=${NOTION_TOKEN}
      - NOTION_DATABASE_ID=${NOTION_DB_ID}

  # üìß Gmail MCP Agent
  gmail-mcp:
    build:
      context: ../mcp-servers/gmail-mcp
      dockerfile: ../../infra/Dockerfile.mcp
    container_name: mcp-gmail
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
    volumes:
      - ../mcp-servers/gmail-mcp/credentials.json:/app/credentials.json
      - ../mcp-servers/gmail-mcp/token.json:/app/token.json

  # üìÖ Calendar MCP Agent
  calendar-mcp:
    build:
      context: ../mcp-servers/calendar-mcp
      dockerfile: ../../infra/Dockerfile.mcp
    container_name: mcp-calendar
    ports:
      - "3004:3004"
    environment:
      - PORT=3004
    volumes:
      - ../mcp-servers/calendar-mcp/credentials.json:/app/credentials.json
      - ../mcp-servers/calendar-mcp/token.json:/app/token.json

  # üé® Frontend (Vite + React)
  frontend:
    build:
      context: ../frontend
      dockerfile: ../infra/Dockerfile.frontend
    container_name: job-frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_TARGET=http://backend:8000
    depends_on:
      - backend
    volumes:
      - ../frontend:/app
      - /app/node_modules

volumes:
  weaviate_data: